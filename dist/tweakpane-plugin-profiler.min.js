!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).TweakpaneProfilerBladePlugin={})}(this,(function(t){"use strict";class e{measure(t,e){const i=performance.now();e();return performance.now()-i}}class i{constructor(){this.observers_={}}on(t,e){let i=this.observers_[t];return i||(i=this.observers_[t]=[]),i.push({handler:e}),this}off(t,e){const i=this.observers_[t];return i&&(this.observers_[t]=i.filter((t=>t.handler!==e))),this}emit(t,e){const i=this.observers_[t];i&&i.forEach((t=>{t.handler(e)}))}}const s="tp";function r(t){return(e,i)=>[s,"-",t,"v",e?`_${e}`:"",i?`-${i}`:""].join("")}function n(t){return t.rawValue}function a(t,e,i){!function(t,e){var i,s;t.emitter.on("change",(i=n,s=e,t=>s(i(t)))),e(t.rawValue)}(t.value(e),i)}class l{constructor(t,e){var s;this.constraint_=null==e?void 0:e.constraint,this.equals_=null!==(s=null==e?void 0:e.equals)&&void 0!==s?s:(t,e)=>t===e,this.emitter=new i,this.rawValue_=t}get constraint(){return this.constraint_}get rawValue(){return this.rawValue_}set rawValue(t){this.setRawValue(t,{forceEmit:!1,last:!0})}setRawValue(t,e){const i=null!=e?e:{forceEmit:!1,last:!0},s=this.constraint_?this.constraint_.constrain(t):t;(!this.equals_(this.rawValue_,s)||i.forceEmit)&&(this.emitter.emit("beforechange",{sender:this}),this.rawValue_=s,this.emitter.emit("change",{options:i,rawValue:s,sender:this}))}}class o{constructor(t){this.emitter=new i,this.value_=t}get rawValue(){return this.value_}set rawValue(t){this.setRawValue(t,{forceEmit:!1,last:!0})}setRawValue(t,e){const i=null!=e?e:{forceEmit:!1,last:!0};(this.value_!==t||i.forceEmit)&&(this.emitter.emit("beforechange",{sender:this}),this.value_=t,this.emitter.emit("change",{options:i,rawValue:this.value_,sender:this}))}}function h(t,e){const i=null==e?void 0:e.constraint,s=null==e?void 0:e.equals;return i||s?new l(t,e):new o(t)}class c{constructor(t){this.emitter=new i,this.valMap_=t;for(const t in this.valMap_){this.valMap_[t].emitter.on("change",(()=>{this.emitter.emit("change",{key:t,sender:this})}))}}static createCore(t){return Object.keys(t).reduce(((e,i)=>Object.assign(e,{[i]:h(t[i])})),{})}static fromObject(t){const e=this.createCore(t);return new c(e)}get(t){return this.valMap_[t].rawValue}set(t,e){this.valMap_[t].rawValue=e}value(t){return this.valMap_[t]}}function d(t){return e=>i=>{if(!e&&void 0===i)return{succeeded:!1,value:void 0};if(e&&void 0===i)return{succeeded:!0,value:void 0};const s=t(i);return void 0!==s?{succeeded:!0,value:s}:{succeeded:!1,value:void 0}}}function u(t){return{custom:e=>d(e)(t),boolean:d((t=>"boolean"==typeof t?t:void 0))(t),number:d((t=>"number"==typeof t?t:void 0))(t),string:d((t=>"string"==typeof t?t:void 0))(t),function:d((t=>"function"==typeof t?t:void 0))(t),constant:e=>d((t=>t===e?e:void 0))(t),raw:d((t=>t))(t),object:e=>d((t=>{var i;if(null!==(i=t)&&"object"==typeof i)return function(t,e){return Object.keys(e).reduce(((i,s)=>{if(void 0===i)return;const r=(0,e[s])(t[s]);return r.succeeded?Object.assign(Object.assign({},i),{[s]:r.value}):void 0}),{})}(t,e)}))(t),array:e=>d((t=>{var i;if(Array.isArray(t))return i=e,t.reduce(((t,e)=>{if(void 0===t)return;const s=i(e);return s.succeeded&&void 0!==s.value?[...t,s.value]:void 0}),[])}))(t)}}const _={optional:u(!0),required:u(!1)};const p=r(""),m={veryfirst:"vfst",first:"fst",last:"lst",verylast:"vlst"};const v=r("lbl");class f{constructor(t,e){this.element=t.createElement("div"),this.element.classList.add(v()),e.viewProps.bindClassModifiers(this.element);const i=t.createElement("div");i.classList.add(v("l")),a(e.props,"label",(e=>{!function(t){return null==t}(e)?(this.element.classList.remove(v(void 0,"nol")),function(t){for(;t.childNodes.length>0;)t.removeChild(t.childNodes[0])}(i),i.appendChild(function(t,e){const i=t.createDocumentFragment();return e.split("\n").map((e=>t.createTextNode(e))).forEach(((e,s)=>{s>0&&i.appendChild(t.createElement("br")),i.appendChild(e)})),i}(t,e))):this.element.classList.add(v(void 0,"nol"))})),this.element.appendChild(i),this.labelElement=i;const s=t.createElement("div");s.classList.add(v("v")),this.element.appendChild(s),this.valueElement=s}}class g extends class{constructor(t){this.parent_=null,this.blade=t.blade,this.view=t.view,this.viewProps=t.viewProps;const e=this.view.element;this.blade.value("positions").emitter.on("change",(()=>{["veryfirst","first","last","verylast"].forEach((t=>{e.classList.remove(p(void 0,m[t]))})),this.blade.get("positions").forEach((t=>{e.classList.add(p(void 0,m[t]))}))})),this.viewProps.handleDispose((()=>{!function(t){t&&t.parentElement&&t.parentElement.removeChild(t)}(e)}))}get parent(){return this.parent_}}{constructor(t,e){const i=e.valueController.viewProps;super(Object.assign(Object.assign({},e),{view:new f(t,{props:e.props,viewProps:i}),viewProps:i})),this.props=e.props,this.valueController=e.valueController,this.view.valueElement.appendChild(this.valueController.view.element)}}class w{constructor(){this.disabled=!1,this.emitter=new i}dispose(){}tick(){this.disabled||this.emitter.emit("tick",{sender:this})}}class b{constructor(t,e){this.disabled_=!1,this.timerId_=null,this.onTick_=this.onTick_.bind(this),this.doc_=t,this.emitter=new i,this.interval_=e,this.setTimer_()}get disabled(){return this.disabled_}set disabled(t){this.disabled_=t,this.disabled_?this.clearTimer_():this.setTimer_()}dispose(){this.clearTimer_()}clearTimer_(){if(null===this.timerId_)return;const t=this.doc_.defaultView;t&&t.clearInterval(this.timerId_),this.timerId_=null}setTimer_(){if(this.clearTimer_(),this.interval_<=0)return;const t=this.doc_.defaultView;t&&(this.timerId_=t.setInterval(this.onTick_,this.interval_))}onTick_(){this.disabled_||this.emitter.emit("tick",{sender:this})}}const y={defaultInterval:200,defaultLineCount:3};class E extends class{constructor(t){this.controller_=t}get disabled(){return this.controller_.viewProps.get("disabled")}set disabled(t){this.controller_.viewProps.set("disabled",t)}get hidden(){return this.controller_.viewProps.get("hidden")}set hidden(t){this.controller_.viewProps.set("hidden",t)}dispose(){this.controller_.viewProps.set("disposed",!0)}}{measure(t,e){this.controller_.valueController.measure(t,e)}get measureHandler(){return this.controller_.valueController.measureHandler}set measureHandler(t){this.controller_.valueController.measureHandler=t}}function C(t,e,i,s){return new(i||(i=Promise))((function(r,n){function a(t){try{o(s.next(t))}catch(t){n(t)}}function l(t){try{o(s.throw(t))}catch(t){n(t)}}function o(t){var e;t.done?r(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,l)}o((s=s.apply(t,e||[])).next())}))}class M{constructor(){this.__map=new Map,this.__setUsed=new Set}get(t){return this.__setUsed.add(t),this.__map.get(t)}getOrCreate(t,e){this.__setUsed.add(t);let i=this.__map.get(t);return null==i&&(i=e(),this.__map.set(t,i)),i}set(t,e){this.__setUsed.add(t),this.__map.set(t,e)}resetUsedSet(){this.__setUsed.clear()}vaporize(t){Array.from(this.__map.entries()).forEach((([e,i])=>{this.__setUsed.has(e)||(this.__map.delete(e),null==t||t([e,i]))}))}}class D{constructor(t){this.__recalcForEach=0,this.__countUntilRecalc=0,this.__history=[],this.__index=0,this.__count=0,this.__cache=0,this.__length=t,this.__recalcForEach=t;for(let e=0;e<t;e++)this.__history[e]=0}get mean(){const t=Math.min(this.__count,this.__length);return 0===t?0:this.__cache/t}get recalcForEach(){return this.__recalcForEach}set recalcForEach(t){const e=t-this.__recalcForEach;this.__recalcForEach=t,this.__countUntilRecalc=Math.max(0,this.__countUntilRecalc+e)}reset(){this.__index=0,this.__count=0,this.__cache=0,this.__countUntilRecalc=0;for(let t=0;t<this.__length;t++)this.__history[t]=0}push(t){const e=this.__history[this.__index];this.__history[this.__index]=t,this.__count++,this.__index=(this.__index+1)%this.__length,0===this.__countUntilRecalc?this.recalc():(this.__countUntilRecalc--,this.__cache-=e,this.__cache+=t)}recalc(){this.__countUntilRecalc=this.__recalcForEach;const t=this.__history.slice(0,Math.min(this.__count,this.__length)).reduce(((t,e)=>t+e),0);this.__cache=t}}function x(t,e){if("function"!=typeof e)return x(t,(t=>t<e));const i=e;let s=0,r=t.length;for(;s<r;){const e=s+r>>1;i(t[e])?s=e+1:r=e}return s}class k{constructor(t){this.__history=[],this.__sorted=[],this.__index=0,this.__length=t}get median(){return this.percentile(50)}percentile(t){return 0===this.__history.length?0:this.__sorted[Math.round(.01*t*(this.__history.length-1))]}reset(){this.__index=0,this.__history=[],this.__sorted=[]}push(t){const e=this.__history[this.__index];if(this.__history[this.__index]=t,this.__index=(this.__index+1)%this.__length,this.__sorted.length===this.__length){const t=x(this.__sorted,e);this.__sorted.splice(t,1)}const i=x(this.__sorted,t);this.__sorted.splice(i,0,t)}}class P{constructor(t){this.handler=t,this.id_=0,this.latestResolved_=-1}add(t){const e=this.id_;this.id_++,t.then((t=>{e>this.latestResolved_&&(this.handler(t),this.latestResolved_=e)}))}}function T(t,e){let i=0;for(let s=0;s<t.length;s++)i+=t[s]*e[s];return i}function U(t){return Math.min(Math.max(t,0),1)}function S(t){const e=[1,t=U(t),t*t,t*t*t],i=[e[2],e[3]].map((t=>t*e[2])),s=[T(e,[.13572138,4.6153926,-42.66032258,132.13108234])+T(i,[-152.94239396,59.28637943]),T(e,[.09140261,2.19418839,4.84296658,-14.18503333])+T(i,[4.27729857,2.82956604]),T(e,[.1066733,12.64194608,-60.58204836,110.36276771])+T(i,[-89.90310912,27.34824973])];return`rgb( ${s.map((t=>256*U(t))).join(", ")} )`}const V=r("profiler");class L{constructor(t,e){this.targetDelta=e.targetDelta,this.deltaUnit=e.deltaUnit,this.fractionDigits=e.fractionDigits,this.calcMode=e.calcMode,this.element=t.createElement("div"),this.element.classList.add(V()),e.viewProps.bindClassModifiers(this.element),this.svgRootElement_=t.createElementNS("http://www.w3.org/2000/svg","svg"),this.svgRootElement_.classList.add(V("root")),this.element.appendChild(this.svgRootElement_),this.entryContainerElement_=t.createElementNS("http://www.w3.org/2000/svg","g"),this.entryContainerElement_.classList.add(V("container")),this.entryContainerElement_.setAttribute("transform","translate( 1, 1 )"),this.svgRootElement_.appendChild(this.entryContainerElement_),this.tooltipElement_=t.createElement("div"),this.tooltipElement_.classList.add(V("tooltip")),this.tooltipElement_.style.display="none",this.element.appendChild(this.tooltipElement_),this.tooltipInsideElement_=t.createElement("div"),this.tooltipInsideElement_.classList.add(V("tooltipinside")),this.tooltipElement_.appendChild(this.tooltipInsideElement_),this.labelElement_=t.createElement("div"),this.labelElement_.classList.add(V("label")),this.labelElement_.textContent=this.deltaToDisplayDelta(0),this.element.appendChild(this.labelElement_),this.entryElementCacheMap_=new M,this.hoveringEntry_=null}update(t){const e=this.entryToDelta(t);this.labelElement_.textContent=this.deltaToDisplayDelta(e),this.entryElementCacheMap_.resetUsedSet();const i=160/Math.max(this.targetDelta,e);this.addEntry_(t,this.entryContainerElement_,i),this.entryElementCacheMap_.vaporize((([t,e])=>{e.remove(),this.hoveringEntry_===t&&(this.hoveringEntry_=null)})),this.updateTooltip_()}updateTooltip_(){const t=this.hoveringEntry_;if(t){const e=this.entryElementCacheMap_.get(t),i=null==e?void 0:e.getAttribute("data-delta"),s=`${t}\n${this.deltaToDisplayDelta(parseFloat(null!=i?i:"0.0"))}`;this.tooltipElement_.style.display="block",this.tooltipInsideElement_.textContent=s}else this.tooltipElement_.style.display="none"}addEntry_(t,e,i){const s=t.path,r=this.entryElementCacheMap_.getOrCreate(s,(()=>{const t=document.createElementNS("http://www.w3.org/2000/svg","g");t.classList.add(V("entry")),e.appendChild(t),this.entryElementCacheMap_.set(s,t);const i=document.createElementNS("http://www.w3.org/2000/svg","rect");return i.classList.add(V("entryrect")),t.appendChild(i),i.addEventListener("mouseenter",(()=>{this.hoveringEntry_=s,this.updateTooltip_()})),i.addEventListener("mouseleave",(()=>{this.hoveringEntry_=null,this.updateTooltip_()})),t})),n=this.entryToDelta(t);r.setAttribute("data-delta",`${n}`);const a=r.childNodes[0];a.setAttribute("width",`${Math.max(.01,n*i-1)}px`),a.setAttribute("height","9px");const l=.15+.7*U(n/this.targetDelta);if(a.setAttribute("fill",S(l)),t.children.length>0){let e=0;t.children.forEach((t=>{this.addEntry_(t,r,i).setAttribute("transform",`translate( ${e}, 10 )`),e+=this.entryToDelta(t)*i}))}return r}entryToDelta(t){if("frame"===this.calcMode)return t.delta;if("mean"===this.calcMode)return t.deltaMean;if("median"===this.calcMode)return t.deltaMedian;throw new Error('Unreachable! calcMode must be one of "frame", "mean", or "median"')}deltaToDisplayDelta(t){return`${t.toFixed(this.fractionDigits)} ${this.deltaUnit}`}}function R(t){let e=0;return t.forEach((t=>e+=t)),e}class j{constructor(t,e){this.targetDelta=e.targetDelta,this.bufferSize=e.bufferSize,this.onTick_=this.onTick_.bind(this),this.ticker_=e.ticker,this.ticker_.emitter.on("tick",this.onTick_),this.viewProps=e.viewProps,this.view=new L(t,{targetDelta:this.targetDelta,deltaUnit:e.deltaUnit,fractionDigits:e.fractionDigits,calcMode:e.calcMode,viewProps:this.viewProps}),this.viewProps.handleDispose((()=>{this.ticker_.dispose()})),this.measureHandler=e.measureHandler,this.measureStack_=[],this.latestEntry_={name:"root",path:"/root",delta:0,deltaMean:0,deltaMedian:0,selfDelta:0,selfDeltaMean:0,selfDeltaMedian:0,children:[]},this.latestPromiseHandler_=new P((t=>{this.latestEntry_=t})),this.entryCalcCacheMap_=new M}measure(t,e){var i;const s=this.measureStack_[this.measureStack_.length-1],r=`${null!==(i=null==s?void 0:s.path)&&void 0!==i?i:""}/${t}`;null==s&&this.entryCalcCacheMap_.resetUsedSet();const{meanCalc:n,medianCalc:a}=this.entryCalcCacheMap_.getOrCreate(r,(()=>({meanCalc:new D(this.bufferSize),medianCalc:new k(this.bufferSize)}))),l={path:r,promiseChildren:[]};this.measureStack_.push(l);const o=(()=>C(this,void 0,void 0,(function*(){const i=yield Promise.resolve(this.measureHandler.measure(r,e)),s=yield Promise.all(l.promiseChildren),o=i-R(s.map((t=>t.delta)));n.push(o),a.push(o);const h=n.mean,c=a.median,d=R(s.map((t=>t.deltaMean))),u=R(s.map((t=>t.deltaMedian)));return{name:t,path:r,delta:i,deltaMean:h+d,deltaMedian:c+u,selfDelta:o,selfDeltaMean:h,selfDeltaMedian:c,children:s}})))();null==s||s.promiseChildren.push(o),this.measureStack_.pop(),null==s&&(this.latestPromiseHandler_.add(o),this.entryCalcCacheMap_.vaporize())}onTick_(){this.view.update(this.latestEntry_)}}function H(t,e){return 0===e?new w:new b(t,null!=e?e:y.defaultInterval)}function I(t){switch(t){case"frame":case"mean":case"median":return t;default:return}}const O={id:"profiler",type:"blade",css:".tp-profilerv{position:relative}.tp-profilerv_root{background-color:var(--mo-bg);width:100%;height:calc( 2.0 * var(--bld-us))}.tp-profilerv_entryrect{rx:var(--elm-br);ry:var(--elm-br);stroke:transparent;stroke-width:1px;filter:saturate(0.5)}.tp-profilerv_entryrect:hover{filter:saturate(1)}.tp-profilerv_tooltip{position:absolute;right:100%;top:0;overflow:hidden;background:var(--bs-bg)}.tp-profilerv_tooltipinside{padding:0 4px;overflow:visible;white-space:pre;text-align:right;background:var(--mo-bg);color:var(--in-fg)}.tp-profilerv_label{color:var(--mo-fg);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}",accept(t){const e=_,i=function(t,e){const i=_.required.object(e)(t);return i.succeeded?i.value:void 0}(t,{view:e.required.constant("profiler"),targetDelta:e.optional.number,bufferSize:e.optional.number,deltaUnit:e.optional.string,fractionDigits:e.optional.number,calcMode:e.optional.custom(I),label:e.optional.string,interval:e.optional.number,measureHandler:e.optional.raw});return i?{params:i}:null},controller(t){var i,s,r,n,a,l,o;const h=null!==(i=t.params.interval)&&void 0!==i?i:500,d=null!==(s=t.params.targetDelta)&&void 0!==s?s:16.67,u=null!==(r=t.params.bufferSize)&&void 0!==r?r:30,_=null!==(n=t.params.deltaUnit)&&void 0!==n?n:"ms",p=null!==(a=t.params.fractionDigits)&&void 0!==a?a:2,m=null!==(l=t.params.calcMode)&&void 0!==l?l:"mean",v=null!==(o=t.params.measureHandler)&&void 0!==o?o:new e;return new g(t.document,{blade:t.blade,props:c.fromObject({label:t.params.label}),valueController:new j(t.document,{ticker:H(t.document,h),targetDelta:d,bufferSize:u,deltaUnit:_,fractionDigits:p,calcMode:m,viewProps:t.viewProps,measureHandler:v})})},api:t=>t.controller instanceof g&&t.controller.valueController instanceof j?new E(t.controller):null};t.ProfilerBladeDefaultMeasureHandler=e,t.ProfilerBladePlugin=O,t.plugin=O,Object.defineProperty(t,"__esModule",{value:!0})}));
