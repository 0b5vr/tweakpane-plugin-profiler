!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TweakpaneProfilerBladePlugin={})}(this,(function(e){"use strict";class t{measure(e){const t=performance.now();e();return performance.now()-t}}class i{constructor(){this.observers_={}}on(e,t){let i=this.observers_[e];return i||(i=this.observers_[e]=[]),i.push({handler:t}),this}off(e,t){const i=this.observers_[e];return i&&(this.observers_[e]=i.filter((e=>e.handler!==t))),this}emit(e,t){const i=this.observers_[e];i&&i.forEach((e=>{e.handler(t)}))}}const s="tp";function r(e){return(t,i)=>[s,"-",e,"v",t?`_${t}`:"",i?`-${i}`:""].join("")}function n(e){return e.rawValue}function a(e,t,i){!function(e,t){var i,s;e.emitter.on("change",(i=n,s=t,e=>s(i(e)))),t(e.rawValue)}(e.value(t),i)}class l{constructor(e,t){var s;this.constraint_=null==t?void 0:t.constraint,this.equals_=null!==(s=null==t?void 0:t.equals)&&void 0!==s?s:(e,t)=>e===t,this.emitter=new i,this.rawValue_=e}get constraint(){return this.constraint_}get rawValue(){return this.rawValue_}set rawValue(e){this.setRawValue(e,{forceEmit:!1,last:!0})}setRawValue(e,t){const i=null!=t?t:{forceEmit:!1,last:!0},s=this.constraint_?this.constraint_.constrain(e):e;(!this.equals_(this.rawValue_,s)||i.forceEmit)&&(this.emitter.emit("beforechange",{sender:this}),this.rawValue_=s,this.emitter.emit("change",{options:i,rawValue:s,sender:this}))}}class o{constructor(e){this.emitter=new i,this.value_=e}get rawValue(){return this.value_}set rawValue(e){this.setRawValue(e,{forceEmit:!1,last:!0})}setRawValue(e,t){const i=null!=t?t:{forceEmit:!1,last:!0};(this.value_!==e||i.forceEmit)&&(this.emitter.emit("beforechange",{sender:this}),this.value_=e,this.emitter.emit("change",{options:i,rawValue:this.value_,sender:this}))}}function c(e,t){const i=null==t?void 0:t.constraint,s=null==t?void 0:t.equals;return i||s?new l(e,t):new o(e)}class h{constructor(e){this.emitter=new i,this.valMap_=e;for(const e in this.valMap_){this.valMap_[e].emitter.on("change",(()=>{this.emitter.emit("change",{key:e,sender:this})}))}}static createCore(e){return Object.keys(e).reduce(((t,i)=>Object.assign(t,{[i]:c(e[i])})),{})}static fromObject(e){const t=this.createCore(e);return new h(t)}get(e){return this.valMap_[e].rawValue}set(e,t){this.valMap_[e].rawValue=t}value(e){return this.valMap_[e]}}function d(e){return t=>i=>{if(!t&&void 0===i)return{succeeded:!1,value:void 0};if(t&&void 0===i)return{succeeded:!0,value:void 0};const s=e(i);return void 0!==s?{succeeded:!0,value:s}:{succeeded:!1,value:void 0}}}function u(e){return{custom:t=>d(t)(e),boolean:d((e=>"boolean"==typeof e?e:void 0))(e),number:d((e=>"number"==typeof e?e:void 0))(e),string:d((e=>"string"==typeof e?e:void 0))(e),function:d((e=>"function"==typeof e?e:void 0))(e),constant:t=>d((e=>e===t?t:void 0))(e),raw:d((e=>e))(e),object:t=>d((e=>{var i;if(null!==(i=e)&&"object"==typeof i)return function(e,t){return Object.keys(t).reduce(((i,s)=>{if(void 0===i)return;const r=(0,t[s])(e[s]);return r.succeeded?Object.assign(Object.assign({},i),{[s]:r.value}):void 0}),{})}(e,t)}))(e),array:t=>d((e=>{var i;if(Array.isArray(e))return i=t,e.reduce(((e,t)=>{if(void 0===e)return;const s=i(t);return s.succeeded&&void 0!==s.value?[...e,s.value]:void 0}),[])}))(e)}}const _={optional:u(!0),required:u(!1)};const p=r(""),m={veryfirst:"vfst",first:"fst",last:"lst",verylast:"vlst"};const v=r("lbl");class f{constructor(e,t){this.element=e.createElement("div"),this.element.classList.add(v()),t.viewProps.bindClassModifiers(this.element);const i=e.createElement("div");i.classList.add(v("l")),a(t.props,"label",(t=>{!function(e){return null==e}(t)?(this.element.classList.remove(v(void 0,"nol")),function(e){for(;e.childNodes.length>0;)e.removeChild(e.childNodes[0])}(i),i.appendChild(function(e,t){const i=e.createDocumentFragment();return t.split("\n").map((t=>e.createTextNode(t))).forEach(((t,s)=>{s>0&&i.appendChild(e.createElement("br")),i.appendChild(t)})),i}(e,t))):this.element.classList.add(v(void 0,"nol"))})),this.element.appendChild(i),this.labelElement=i;const s=e.createElement("div");s.classList.add(v("v")),this.element.appendChild(s),this.valueElement=s}}class g extends class{constructor(e){this.parent_=null,this.blade=e.blade,this.view=e.view,this.viewProps=e.viewProps;const t=this.view.element;this.blade.value("positions").emitter.on("change",(()=>{["veryfirst","first","last","verylast"].forEach((e=>{t.classList.remove(p(void 0,m[e]))})),this.blade.get("positions").forEach((e=>{t.classList.add(p(void 0,m[e]))}))})),this.viewProps.handleDispose((()=>{!function(e){e&&e.parentElement&&e.parentElement.removeChild(e)}(t)}))}get parent(){return this.parent_}}{constructor(e,t){const i=t.valueController.viewProps;super(Object.assign(Object.assign({},t),{view:new f(e,{props:t.props,viewProps:i}),viewProps:i})),this.props=t.props,this.valueController=t.valueController,this.view.valueElement.appendChild(this.valueController.view.element)}}class w{constructor(){this.disabled=!1,this.emitter=new i}dispose(){}tick(){this.disabled||this.emitter.emit("tick",{sender:this})}}class b{constructor(e,t){this.disabled_=!1,this.timerId_=null,this.onTick_=this.onTick_.bind(this),this.doc_=e,this.emitter=new i,this.interval_=t,this.setTimer_()}get disabled(){return this.disabled_}set disabled(e){this.disabled_=e,this.disabled_?this.clearTimer_():this.setTimer_()}dispose(){this.clearTimer_()}clearTimer_(){if(null===this.timerId_)return;const e=this.doc_.defaultView;e&&e.clearInterval(this.timerId_),this.timerId_=null}setTimer_(){if(this.clearTimer_(),this.interval_<=0)return;const e=this.doc_.defaultView;e&&(this.timerId_=e.setInterval(this.onTick_,this.interval_))}onTick_(){this.disabled_||this.emitter.emit("tick",{sender:this})}}const y={defaultInterval:200,defaultLineCount:3};class E extends class{constructor(e){this.controller_=e}get disabled(){return this.controller_.viewProps.get("disabled")}set disabled(e){this.controller_.viewProps.set("disabled",e)}get hidden(){return this.controller_.viewProps.get("hidden")}set hidden(e){this.controller_.viewProps.set("hidden",e)}dispose(){this.controller_.viewProps.set("disposed",!0)}}{measure(e,t){this.controller_.valueController.measure(e,t)}get measureHandler(){return this.controller_.valueController.measureHandler}set measureHandler(e){this.controller_.valueController.measureHandler=e}}class C{constructor(){this.map=new Map,this.keySet=new Set}get(e){return this.map.get(e)}getOrCreate(e,t){this.keySet.has(e)||this.keySet.add(e);let i=this.map.get(e);return null==i&&(i=t(),this.map.set(e,i)),i}set(e,t){this.keySet.has(e)||this.keySet.add(e),this.map.set(e,t)}resetUsedSet(){this.keySet.clear()}vaporize(e){for(const[t,i]of this.map.entries())this.keySet.has(t)||(this.map.delete(t),null==e||e([t,i]))}}class M{constructor(e){this.__recalcForEach=0,this.__countUntilRecalc=0,this.__history=[],this.__index=0,this.__count=0,this.__cache=0,this.__length=e,this.__recalcForEach=e;for(let t=0;t<e;t++)this.__history[t]=0}get mean(){const e=Math.min(this.__count,this.__length);return 0===e?0:this.__cache/e}get recalcForEach(){return this.__recalcForEach}set recalcForEach(e){const t=e-this.__recalcForEach;this.__recalcForEach=e,this.__countUntilRecalc=Math.max(0,this.__countUntilRecalc+t)}reset(){this.__index=0,this.__count=0,this.__cache=0,this.__countUntilRecalc=0;for(let e=0;e<this.__length;e++)this.__history[e]=0}push(e){const t=this.__history[this.__index];this.__history[this.__index]=e,this.__count++,this.__index=(this.__index+1)%this.__length,0===this.__countUntilRecalc?this.recalc():(this.__countUntilRecalc--,this.__cache-=t,this.__cache+=e)}recalc(){this.__countUntilRecalc=this.__recalcForEach;const e=this.__history.slice(0,Math.min(this.__count,this.__length)).reduce(((e,t)=>e+t),0);this.__cache=e}}function D(e,t){if("function"!=typeof t)return D(e,(e=>e<t));const i=t;let s=0,r=e.length;for(;s<r;){const t=s+r>>1;i(e[t])?s=t+1:r=t}return s}class k{constructor(e){this.__history=[],this.__sorted=[],this.__index=0,this.__length=e}get median(){return this.percentile(50)}percentile(e){return 0===this.__history.length?0:this.__sorted[Math.round(.01*e*(this.__history.length-1))]}reset(){this.__index=0,this.__history=[],this.__sorted=[]}push(e){const t=this.__history[this.__index];if(this.__history[this.__index]=e,this.__index=(this.__index+1)%this.__length,this.__sorted.length===this.__length){const e=D(this.__sorted,t);this.__sorted.splice(e,1)}const i=D(this.__sorted,e);this.__sorted.splice(i,0,e)}}function x(e,t){let i=0;for(let s=0;s<e.length;s++)i+=e[s]*t[s];return i}function P(e){return Math.min(Math.max(e,0),1)}function T(e){const t=[1,e=P(e),e*e,e*e*e],i=[t[2],t[3]].map((e=>e*t[2])),s=[x(t,[.13572138,4.6153926,-42.66032258,132.13108234])+x(i,[-152.94239396,59.28637943]),x(t,[.09140261,2.19418839,4.84296658,-14.18503333])+x(i,[4.27729857,2.82956604]),x(t,[.1066733,12.64194608,-60.58204836,110.36276771])+x(i,[-89.90310912,27.34824973])];return`rgb( ${s.map((e=>256*P(e))).join(", ")} )`}const S=r("profiler");class V{constructor(e,t){this.targetDelta=t.targetDelta,this.deltaUnit=t.deltaUnit,this.fractionDigits=t.fractionDigits,this.calcMode=t.calcMode,this.element=e.createElement("div"),this.element.classList.add(S()),t.viewProps.bindClassModifiers(this.element),this.svgRootElement_=e.createElementNS("http://www.w3.org/2000/svg","svg"),this.svgRootElement_.classList.add(S("root")),this.element.appendChild(this.svgRootElement_),this.entryContainerElement_=e.createElementNS("http://www.w3.org/2000/svg","g"),this.entryContainerElement_.classList.add(S("container")),this.entryContainerElement_.setAttribute("transform","translate( 1, 1 )"),this.svgRootElement_.appendChild(this.entryContainerElement_),this.tooltipElement_=e.createElement("div"),this.tooltipElement_.classList.add(S("tooltip")),this.tooltipElement_.style.display="none",this.element.appendChild(this.tooltipElement_),this.tooltipInsideElement_=e.createElement("div"),this.tooltipInsideElement_.classList.add(S("tooltipinside")),this.tooltipElement_.appendChild(this.tooltipInsideElement_),this.labelElement_=e.createElement("div"),this.labelElement_.classList.add(S("label")),this.labelElement_.textContent=this.deltaToDisplayDelta_(0),this.element.appendChild(this.labelElement_),this.entryElementCacheMap_=new C,this.hoveringEntry_=null}update(e){const t=this.entryToDelta_(e);this.labelElement_.textContent=this.deltaToDisplayDelta_(t),this.entryElementCacheMap_.resetUsedSet();const i=160/Math.max(this.targetDelta,t);let s=0;for(const t of e.children){this.addEntry_(t,"",this.entryContainerElement_,i).setAttribute("transform",`translate( ${s}, 0 )`),s+=this.entryToDelta_(t)*i}this.entryElementCacheMap_.vaporize((([e,t])=>{t.remove(),this.hoveringEntry_===e&&(this.hoveringEntry_=null)})),this.updateTooltip_()}updateTooltip_(){const e=this.hoveringEntry_;if(e){const t=this.entryElementCacheMap_.get(e),i=null==t?void 0:t.getAttribute("data-delta"),s=`${e}\n${this.deltaToDisplayDelta_(parseFloat(null!=i?i:"0.0"))}`;this.tooltipElement_.style.display="block",this.tooltipInsideElement_.textContent=s}else this.tooltipElement_.style.display="none"}addEntry_(e,t,i,s){const r=`${t}/${e.name}`,n=this.entryElementCacheMap_.getOrCreate(r,(()=>{const e=document.createElementNS("http://www.w3.org/2000/svg","g");e.classList.add(S("entry")),i.appendChild(e),this.entryElementCacheMap_.set(r,e);const t=document.createElementNS("http://www.w3.org/2000/svg","rect");return t.classList.add(S("entryrect")),e.appendChild(t),t.addEventListener("mouseenter",(()=>{this.hoveringEntry_=r,this.updateTooltip_()})),t.addEventListener("mouseleave",(()=>{this.hoveringEntry_=null,this.updateTooltip_()})),e})),a=this.entryToDelta_(e);n.setAttribute("data-delta",`${a}`);const l=n.childNodes[0];l.setAttribute("width",`${Math.max(.01,a*s-1)}px`),l.setAttribute("height","9px");const o=.15+.7*P(a/this.targetDelta);if(l.setAttribute("fill",T(o)),e.children.length>0){let t=0;e.children.forEach((e=>{this.addEntry_(e,r,n,s).setAttribute("transform",`translate( ${t}, 10 )`),t+=this.entryToDelta_(e)*s}))}return n}entryToDelta_(e){if("frame"===this.calcMode)return e.delta;if("mean"===this.calcMode)return e.deltaMean;if("median"===this.calcMode)return e.deltaMedian;throw new Error('Unreachable! calcMode must be one of "frame", "mean", or "median"')}deltaToDisplayDelta_(e){return`${e.toFixed(this.fractionDigits)} ${this.deltaUnit}`}}function U(e){let t=0;return e.forEach((e=>t+=e)),t}class L{constructor(e,t){this.targetDelta=t.targetDelta,this.bufferSize=t.bufferSize,this.onTick_=this.onTick_.bind(this),this.ticker_=t.ticker,this.ticker_.emitter.on("tick",this.onTick_),this.viewProps=t.viewProps,this.view=new V(e,{targetDelta:this.targetDelta,deltaUnit:t.deltaUnit,fractionDigits:t.fractionDigits,calcMode:t.calcMode,viewProps:this.viewProps}),this.viewProps.handleDispose((()=>{this.ticker_.dispose()})),this.measureHandler=t.measureHandler,this.rootCalcCacheStack_=[this.createNewEntryCalcCache_()]}async measure(e,t){const i=this.rootCalcCacheStack_[this.rootCalcCacheStack_.length-1],s=i.childrenCacheMap.getOrCreate(e,(()=>this.createNewEntryCalcCache_()));var r;s.childrenCacheMap.resetUsedSet(),(r=s.childrenPromiseDelta).splice(0,r.length),this.rootCalcCacheStack_.push(s);const n=Promise.resolve(this.measureHandler.measure(t));i.childrenPromiseDelta.push(n),this.rootCalcCacheStack_.pop(),s.childrenCacheMap.vaporize();const a=U(await Promise.all(s.childrenPromiseDelta)),l=await n-a;s.meanCalc.push(l),s.medianCalc.push(l),s.latest=l}renderEntry(){return this.renderEntryFromCalcCache_("",this.rootCalcCacheStack_[0])}renderEntryFromCalcCache_(e,t){const i=[];for(const e of t.childrenCacheMap.keySet){const s=t.childrenCacheMap.get(e);i.push(this.renderEntryFromCalcCache_(e,s))}const s=t.latest,r=t.meanCalc.mean,n=t.medianCalc.median;return{name:e,delta:s+U(i.map((e=>e.delta))),deltaMean:r+U(i.map((e=>e.deltaMean))),deltaMedian:n+U(i.map((e=>e.deltaMedian))),selfDelta:s,selfDeltaMean:r,selfDeltaMedian:n,children:i}}onTick_(){this.view.update(this.renderEntry())}createNewEntryCalcCache_(){return{meanCalc:new M(this.bufferSize),medianCalc:new k(this.bufferSize),latest:0,childrenCacheMap:new C,childrenPromiseDelta:[]}}}function j(e,t){return 0===t?new w:new b(e,null!=t?t:y.defaultInterval)}function R(e){switch(e){case"frame":case"mean":case"median":return e;default:return}}const F={id:"profiler",type:"blade",css:".tp-profilerv{position:relative}.tp-profilerv_root{background-color:var(--mo-bg);width:100%;height:calc( 2.0 * var(--bld-us))}.tp-profilerv_entryrect{rx:var(--elm-br);ry:var(--elm-br);stroke:transparent;stroke-width:1px;filter:saturate(0.5)}.tp-profilerv_entryrect:hover{filter:saturate(1)}.tp-profilerv_tooltip{position:absolute;right:100%;top:0;overflow:hidden;background:var(--bs-bg)}.tp-profilerv_tooltipinside{padding:0 4px;overflow:visible;white-space:pre;text-align:right;background:var(--mo-bg);color:var(--in-fg)}.tp-profilerv_label{color:var(--mo-fg);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}",accept(e){const t=_,i=function(e,t){const i=_.required.object(t)(e);return i.succeeded?i.value:void 0}(e,{view:t.required.constant("profiler"),targetDelta:t.optional.number,bufferSize:t.optional.number,deltaUnit:t.optional.string,fractionDigits:t.optional.number,calcMode:t.optional.custom(R),label:t.optional.string,interval:t.optional.number,measureHandler:t.optional.raw});return i?{params:i}:null},controller(e){var i,s,r,n,a,l,o;const c=null!==(i=e.params.interval)&&void 0!==i?i:500,d=null!==(s=e.params.targetDelta)&&void 0!==s?s:16.67,u=null!==(r=e.params.bufferSize)&&void 0!==r?r:30,_=null!==(n=e.params.deltaUnit)&&void 0!==n?n:"ms",p=null!==(a=e.params.fractionDigits)&&void 0!==a?a:2,m=null!==(l=e.params.calcMode)&&void 0!==l?l:"mean",v=null!==(o=e.params.measureHandler)&&void 0!==o?o:new t;return new g(e.document,{blade:e.blade,props:h.fromObject({label:e.params.label}),valueController:new L(e.document,{ticker:j(e.document,c),targetDelta:d,bufferSize:u,deltaUnit:_,fractionDigits:p,calcMode:m,viewProps:e.viewProps,measureHandler:v})})},api:e=>e.controller instanceof g&&e.controller.valueController instanceof L?new E(e.controller):null};e.ProfilerBladeDefaultMeasureHandler=t,e.ProfilerBladePlugin=F,e.plugin=F,Object.defineProperty(e,"__esModule",{value:!0})}));
