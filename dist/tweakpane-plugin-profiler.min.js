!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TweakpaneProfilerBladePlugin={})}(this,(function(e){"use strict";class t{measure(e,t){const i=performance.now();t();return performance.now()-i}}class i{constructor(){this.observers_={}}on(e,t){let i=this.observers_[e];return i||(i=this.observers_[e]=[]),i.push({handler:t}),this}off(e,t){const i=this.observers_[e];return i&&(this.observers_[e]=i.filter((e=>e.handler!==t))),this}emit(e,t){const i=this.observers_[e];i&&i.forEach((e=>{e.handler(t)}))}}const s="tp";function r(e){return(t,i)=>[s,"-",e,"v",t?`_${t}`:"",i?`-${i}`:""].join("")}function n(e){return e.rawValue}function a(e,t,i){!function(e,t){var i,s;e.emitter.on("change",(i=n,s=t,e=>s(i(e)))),t(e.rawValue)}(e.value(t),i)}class l{constructor(e,t){var s;this.constraint_=null==t?void 0:t.constraint,this.equals_=null!==(s=null==t?void 0:t.equals)&&void 0!==s?s:(e,t)=>e===t,this.emitter=new i,this.rawValue_=e}get constraint(){return this.constraint_}get rawValue(){return this.rawValue_}set rawValue(e){this.setRawValue(e,{forceEmit:!1,last:!0})}setRawValue(e,t){const i=null!=t?t:{forceEmit:!1,last:!0},s=this.constraint_?this.constraint_.constrain(e):e;(!this.equals_(this.rawValue_,s)||i.forceEmit)&&(this.emitter.emit("beforechange",{sender:this}),this.rawValue_=s,this.emitter.emit("change",{options:i,rawValue:s,sender:this}))}}class o{constructor(e){this.emitter=new i,this.value_=e}get rawValue(){return this.value_}set rawValue(e){this.setRawValue(e,{forceEmit:!1,last:!0})}setRawValue(e,t){const i=null!=t?t:{forceEmit:!1,last:!0};(this.value_!==e||i.forceEmit)&&(this.emitter.emit("beforechange",{sender:this}),this.value_=e,this.emitter.emit("change",{options:i,rawValue:this.value_,sender:this}))}}function d(e,t){const i=null==t?void 0:t.constraint,s=null==t?void 0:t.equals;return i||s?new l(e,t):new o(e)}class h{constructor(e){this.emitter=new i,this.valMap_=e;for(const e in this.valMap_){this.valMap_[e].emitter.on("change",(()=>{this.emitter.emit("change",{key:e,sender:this})}))}}static createCore(e){return Object.keys(e).reduce(((t,i)=>Object.assign(t,{[i]:d(e[i])})),{})}static fromObject(e){const t=this.createCore(e);return new h(t)}get(e){return this.valMap_[e].rawValue}set(e,t){this.valMap_[e].rawValue=t}value(e){return this.valMap_[e]}}function c(e){return t=>i=>{if(!t&&void 0===i)return{succeeded:!1,value:void 0};if(t&&void 0===i)return{succeeded:!0,value:void 0};const s=e(i);return void 0!==s?{succeeded:!0,value:s}:{succeeded:!1,value:void 0}}}function u(e){return{custom:t=>c(t)(e),boolean:c((e=>"boolean"==typeof e?e:void 0))(e),number:c((e=>"number"==typeof e?e:void 0))(e),string:c((e=>"string"==typeof e?e:void 0))(e),function:c((e=>"function"==typeof e?e:void 0))(e),constant:t=>c((e=>e===t?t:void 0))(e),raw:c((e=>e))(e),object:t=>c((e=>{var i;if(null!==(i=e)&&"object"==typeof i)return function(e,t){return Object.keys(t).reduce(((i,s)=>{if(void 0===i)return;const r=(0,t[s])(e[s]);return r.succeeded?Object.assign(Object.assign({},i),{[s]:r.value}):void 0}),{})}(e,t)}))(e),array:t=>c((e=>{var i;if(Array.isArray(e))return i=t,e.reduce(((e,t)=>{if(void 0===e)return;const s=i(t);return s.succeeded&&void 0!==s.value?[...e,s.value]:void 0}),[])}))(e)}}const p={optional:u(!0),required:u(!1)};const _=r(""),m={veryfirst:"vfst",first:"fst",last:"lst",verylast:"vlst"};const v=r("lbl");class f{constructor(e,t){this.element=e.createElement("div"),this.element.classList.add(v()),t.viewProps.bindClassModifiers(this.element);const i=e.createElement("div");i.classList.add(v("l")),a(t.props,"label",(t=>{!function(e){return null==e}(t)?(this.element.classList.remove(v(void 0,"nol")),function(e){for(;e.childNodes.length>0;)e.removeChild(e.childNodes[0])}(i),i.appendChild(function(e,t){const i=e.createDocumentFragment();return t.split("\n").map((t=>e.createTextNode(t))).forEach(((t,s)=>{s>0&&i.appendChild(e.createElement("br")),i.appendChild(t)})),i}(e,t))):this.element.classList.add(v(void 0,"nol"))})),this.element.appendChild(i),this.labelElement=i;const s=e.createElement("div");s.classList.add(v("v")),this.element.appendChild(s),this.valueElement=s}}class g extends class{constructor(e){this.parent_=null,this.blade=e.blade,this.view=e.view,this.viewProps=e.viewProps;const t=this.view.element;this.blade.value("positions").emitter.on("change",(()=>{["veryfirst","first","last","verylast"].forEach((e=>{t.classList.remove(_(void 0,m[e]))})),this.blade.get("positions").forEach((e=>{t.classList.add(_(void 0,m[e]))}))})),this.viewProps.handleDispose((()=>{!function(e){e&&e.parentElement&&e.parentElement.removeChild(e)}(t)}))}get parent(){return this.parent_}}{constructor(e,t){const i=t.valueController.viewProps;super(Object.assign(Object.assign({},t),{view:new f(e,{props:t.props,viewProps:i}),viewProps:i})),this.props=t.props,this.valueController=t.valueController,this.view.valueElement.appendChild(this.valueController.view.element)}}class w{constructor(){this.disabled=!1,this.emitter=new i}dispose(){}tick(){this.disabled||this.emitter.emit("tick",{sender:this})}}class b{constructor(e,t){this.disabled_=!1,this.timerId_=null,this.onTick_=this.onTick_.bind(this),this.doc_=e,this.emitter=new i,this.interval_=t,this.setTimer_()}get disabled(){return this.disabled_}set disabled(e){this.disabled_=e,this.disabled_?this.clearTimer_():this.setTimer_()}dispose(){this.clearTimer_()}clearTimer_(){if(null===this.timerId_)return;const e=this.doc_.defaultView;e&&e.clearInterval(this.timerId_),this.timerId_=null}setTimer_(){if(this.clearTimer_(),this.interval_<=0)return;const e=this.doc_.defaultView;e&&(this.timerId_=e.setInterval(this.onTick_,this.interval_))}onTick_(){this.disabled_||this.emitter.emit("tick",{sender:this})}}const y={defaultInterval:200,defaultLineCount:3};class E extends class{constructor(e){this.controller_=e}get disabled(){return this.controller_.viewProps.get("disabled")}set disabled(e){this.controller_.viewProps.set("disabled",e)}get hidden(){return this.controller_.viewProps.get("hidden")}set hidden(e){this.controller_.viewProps.set("hidden",e)}dispose(){this.controller_.viewProps.set("disposed",!0)}}{measure(e,t){this.controller_.valueController.measure(e,t)}get measureHandler(){return this.controller_.valueController.measureHandler}set measureHandler(e){this.controller_.valueController.measureHandler=e}}function C(e,t,i,s){return new(i||(i=Promise))((function(r,n){function a(e){try{o(s.next(e))}catch(e){n(e)}}function l(e){try{o(s.throw(e))}catch(e){n(e)}}function o(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,l)}o((s=s.apply(e,t||[])).next())}))}class M{constructor(){this.__map=new Map,this.__setUsed=new Set}get(e){return this.__setUsed.add(e),this.__map.get(e)}getOrCreate(e,t){this.__setUsed.add(e);let i=this.__map.get(e);return null==i&&(i=t(),this.__map.set(e,i)),i}set(e,t){this.__setUsed.add(e),this.__map.set(e,t)}resetUsedSet(){this.__setUsed.clear()}vaporize(e){Array.from(this.__map.entries()).forEach((([t,i])=>{this.__setUsed.has(t)||(this.__map.delete(t),null==e||e([t,i]))}))}}function D(e,t){if("function"!=typeof t)return D(e,(e=>e<t));const i=t;let s=0,r=e.length;for(;s<r;){const t=s+r>>1;i(e[t])?s=t+1:r=t}return s}class k{constructor(e){this.__history=[],this.__sorted=[],this.__index=0,this.__length=e}get median(){return this.percentile(50)}percentile(e){return 0===this.__history.length?0:this.__sorted[Math.round(.01*e*(this.__history.length-1))]}reset(){this.__index=0,this.__history=[],this.__sorted=[]}push(e){const t=this.__history[this.__index];if(this.__history[this.__index]=e,this.__index=(this.__index+1)%this.__length,this.__sorted.length===this.__length){const e=D(this.__sorted,t);this.__sorted.splice(e,1)}const i=D(this.__sorted,e);this.__sorted.splice(i,0,e)}}class P{constructor(e){this.handler=e,this.id_=0,this.latestResolved_=-1}add(e){const t=this.id_;this.id_++,e.then((e=>{t>this.latestResolved_&&(this.handler(e),this.latestResolved_=t)}))}}function x(e,t){let i=0;for(let s=0;s<e.length;s++)i+=e[s]*t[s];return i}function T(e){return Math.min(Math.max(e,0),1)}function V(e){const t=[1,e=T(e),e*e,e*e*e],i=[t[2],t[3]].map((e=>e*t[2])),s=[x(t,[.13572138,4.6153926,-42.66032258,132.13108234])+x(i,[-152.94239396,59.28637943]),x(t,[.09140261,2.19418839,4.84296658,-14.18503333])+x(i,[4.27729857,2.82956604]),x(t,[.1066733,12.64194608,-60.58204836,110.36276771])+x(i,[-89.90310912,27.34824973])];return`rgb( ${s.map((e=>256*T(e))).join(", ")} )`}const S=r("profiler");class L{constructor(e,t){this.targetDelta=t.targetDelta,this.deltaUnit=t.deltaUnit,this.fractionDigits=t.fractionDigits,this.element=e.createElement("div"),this.element.classList.add(S()),t.viewProps.bindClassModifiers(this.element),this.svgRootElement_=e.createElementNS("http://www.w3.org/2000/svg","svg"),this.svgRootElement_.classList.add(S("root")),this.element.appendChild(this.svgRootElement_),this.entryContainerElement_=e.createElementNS("http://www.w3.org/2000/svg","g"),this.entryContainerElement_.classList.add(S("container")),this.entryContainerElement_.setAttribute("transform","translate( 1, 1 )"),this.svgRootElement_.appendChild(this.entryContainerElement_),this.tooltipElement_=e.createElement("div"),this.tooltipElement_.classList.add(S("tooltip")),this.tooltipElement_.style.display="none",this.element.appendChild(this.tooltipElement_),this.tooltipInsideElement_=e.createElement("div"),this.tooltipInsideElement_.classList.add(S("tooltipinside")),this.tooltipElement_.appendChild(this.tooltipInsideElement_),this.labelElement_=e.createElement("div"),this.labelElement_.classList.add(S("label")),this.labelElement_.textContent=this.deltaToDisplayDelta(0),this.element.appendChild(this.labelElement_),this.entryElementCacheMap_=new M,this.hoveringEntry_=null}update(e){this.labelElement_.textContent=this.deltaToDisplayDelta(e.deltaMedian),this.entryElementCacheMap_.resetUsedSet();const t=160/Math.max(this.targetDelta,e.deltaMedian);this.addEntry_(e,this.entryContainerElement_,t),this.entryElementCacheMap_.vaporize((([e,t])=>{t.remove(),this.hoveringEntry_===e&&(this.hoveringEntry_=null)})),this.updateTooltip_()}updateTooltip_(){const e=this.hoveringEntry_;if(e){const t=this.entryElementCacheMap_.get(e),i=null==t?void 0:t.getAttribute("data-delta"),s=`${e}\n${this.deltaToDisplayDelta(parseFloat(null!=i?i:"0.0"))}`;this.tooltipElement_.style.display="block",this.tooltipInsideElement_.textContent=s}else this.tooltipElement_.style.display="none"}addEntry_(e,t,i){const s=e.path,r=this.entryElementCacheMap_.getOrCreate(s,(()=>{const e=document.createElementNS("http://www.w3.org/2000/svg","g");e.classList.add(S("entry")),t.appendChild(e),this.entryElementCacheMap_.set(s,e);const i=document.createElementNS("http://www.w3.org/2000/svg","rect");return i.classList.add(S("entryrect")),e.appendChild(i),i.addEventListener("mouseenter",(()=>{this.hoveringEntry_=s,this.updateTooltip_()})),i.addEventListener("mouseleave",(()=>{this.hoveringEntry_=null,this.updateTooltip_()})),e}));r.setAttribute("data-delta",`${e.deltaMedian}`);const n=r.childNodes[0];n.setAttribute("width",`${Math.max(.01,e.deltaMedian*i-1)}px`),n.setAttribute("height","9px");const a=.15+.7*T(e.deltaMedian/this.targetDelta);if(n.setAttribute("fill",V(a)),e.children.length>0){let t=0;e.children.forEach((e=>{this.addEntry_(e,r,i).setAttribute("transform",`translate( ${t}, 10 )`),t+=e.deltaMedian*i}))}return r}deltaToDisplayDelta(e){return`${e.toFixed(this.fractionDigits)} ${this.deltaUnit}`}}function U(e){let t=0;return e.forEach((e=>t+=e)),t}class j{constructor(e,t){this.targetDelta=t.targetDelta,this.medianBufferSize=t.medianBufferSize,this.onTick_=this.onTick_.bind(this),this.ticker_=t.ticker,this.ticker_.emitter.on("tick",this.onTick_),this.viewProps=t.viewProps,this.view=new L(e,{targetDelta:this.targetDelta,deltaUnit:t.deltaUnit,fractionDigits:t.fractionDigits,viewProps:this.viewProps}),this.viewProps.handleDispose((()=>{this.ticker_.dispose()})),this.measureHandler=t.measureHandler,this.measureStack_=[],this.latestEntry_={name:"root",path:"/root",delta:0,deltaMedian:0,selfDelta:0,selfDeltaMedian:0,children:[]},this.latestPromiseHandler_=new P((e=>{this.latestEntry_=e})),this.entryCalcCacheMap_=new M}measure(e,t){var i;const s=this.measureStack_[this.measureStack_.length-1],r=`${null!==(i=null==s?void 0:s.path)&&void 0!==i?i:""}/${e}`;null==s&&this.entryCalcCacheMap_.resetUsedSet();const n=this.entryCalcCacheMap_.getOrCreate(r,(()=>new k(this.medianBufferSize))),a={path:r,promiseChildren:[]};this.measureStack_.push(a);const l=(()=>C(this,void 0,void 0,(function*(){const i=yield Promise.resolve(this.measureHandler.measure(r,t)),s=yield Promise.all(a.promiseChildren),l=i-U(s.map((e=>e.delta)));n.push(l);const o=n.median,d=U(s.map((e=>e.deltaMedian)));return{name:e,path:r,delta:i,deltaMedian:o+d,selfDelta:l,selfDeltaMedian:o,children:s}})))();null==s||s.promiseChildren.push(l),this.measureStack_.pop(),null==s&&(this.latestPromiseHandler_.add(l),this.entryCalcCacheMap_.vaporize())}onTick_(){this.view.update(this.latestEntry_)}}function H(e,t){return 0===t?new w:new b(e,null!=t?t:y.defaultInterval)}const I={id:"profiler",type:"blade",css:".tp-profilerv{position:relative}.tp-profilerv_root{background-color:var(--mo-bg);width:100%;height:calc( 2.0 * var(--bld-us))}.tp-profilerv_entryrect{rx:var(--elm-br);ry:var(--elm-br);stroke:transparent;stroke-width:1px;filter:saturate(0.5)}.tp-profilerv_entryrect:hover{filter:saturate(1)}.tp-profilerv_tooltip{position:absolute;right:100%;top:0;overflow:hidden;background:var(--bs-bg)}.tp-profilerv_tooltipinside{padding:0 4px;overflow:visible;white-space:pre;text-align:right;background:var(--mo-bg);color:var(--in-fg)}.tp-profilerv_label{color:var(--mo-fg);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}",accept(e){const t=p,i=function(e,t){const i=p.required.object(t)(e);return i.succeeded?i.value:void 0}(e,{view:t.required.constant("profiler"),targetDelta:t.optional.number,medianBufferSize:t.optional.number,deltaUnit:t.optional.string,fractionDigits:t.optional.number,label:t.optional.string,interval:t.optional.number,measureHandler:t.optional.raw});return i?{params:i}:null},controller(e){var i,s,r,n,a,l;const o=null!==(i=e.params.interval)&&void 0!==i?i:500,d=null!==(s=e.params.targetDelta)&&void 0!==s?s:16.67,c=null!==(r=e.params.medianBufferSize)&&void 0!==r?r:30,u=null!==(n=e.params.deltaUnit)&&void 0!==n?n:"ms",p=null!==(a=e.params.fractionDigits)&&void 0!==a?a:2,_=null!==(l=e.params.measureHandler)&&void 0!==l?l:new t;return new g(e.document,{blade:e.blade,props:h.fromObject({label:e.params.label}),valueController:new j(e.document,{ticker:H(e.document,o),targetDelta:d,medianBufferSize:c,deltaUnit:u,fractionDigits:p,viewProps:e.viewProps,measureHandler:_})})},api:e=>e.controller instanceof g&&e.controller.valueController instanceof j?new E(e.controller):null};e.ProfilerBladeDefaultMeasureHandler=t,e.ProfilerBladePlugin=I,e.plugin=I,Object.defineProperty(e,"__esModule",{value:!0})}));
